# 游戏接口文档 - 心跳挽回战


**接口数量**：2 个  
**功能模块**：游戏化情感互动 - 心跳挽回战

---

## 🎮 游戏逻辑说明

### 游戏背景
"心跳挽回战"是一款模拟情侣关系修复的对话游戏，用户需要通过与 AI 模拟的女友对话，化解矛盾，挽回关系。

### 核心特性

1. **情绪驱动**：根据女友不开心的原因，AI 自动分析情绪类型，决定游戏难度
2. **上下文记忆**：游戏过程中记录所有对话历史（最多保留 10 条），AI 根据上下文生成回复
3. **流式输出**：AI 回复采用 SSE（Server-Sent Events）流式传输，实时显示打字效果
4. **数据隔离**：每局游戏拥有独立的 `sessionId`，通过 `MessageType.GAME` 标识游戏消息
5. **定期清理**：游戏结束后可选择性删除记录，避免占用存储空间

---

## 📡 接口列表

| 接口路径 | 方法 | 功能 | 是否需要登录 |
|---------|------|------|-------------|
| `/love/game/emo` | POST | 情绪检测 - 游戏初始化 | ✅ 是 |
| `/love/game/chat` | POST | 游戏对话 - 流式返回 AI 回复 | ✅ 是 |

---

## 1️⃣ 情绪检测接口（游戏初始化）

### 接口信息

- **接口路径**：`/love/game/emo`
- **请求方式**：`POST`
- **Content-Type**：`application/json`
- **需要登录**：✅ 是（需要 `@LoginCheck` 验证）

---

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| `message` | String | ✅ | 女友不开心的原因 | "她说我不关心她" |
| `chatId` | String | ✅ | 用户 ID（自动从登录态获取） | "23034480211" |

**请求示例**：
```json
{
  "message": "她说我不关心她",
  "chatId": "23034480211"
}
```

---

### 响应结果

#### 成功响应（200）

```json
{
  "code": 0,
  "data": {
    "emo": "生气",
    "sessionId": "1729234567890_23034480211"
  },
  "message": "ok"
}
```

**响应字段说明**：

| 字段名 | 类型 | 说明 | 可能值 |
|--------|------|------|--------|
| `code` | Integer | 状态码，0 表示成功 | 0 |
| `data.emo` | String | AI 分析的情绪类型 | "生气" / "伤心" / "失望" / "委屈" / "愤怒" |
| `data.sessionId` | String | 游戏会话 ID（用于后续对话） | "时间戳_用户ID" |
| `message` | String | 响应消息 | "ok" |

---

#### 失败响应（400/500）

```json
{
  "code": 40100,
  "data": null,
  "message": "未登录"
}
```

---

### 业务逻辑

```
1. 接收用户输入的女友生气原因
   ↓
2. 调用 emoClient（AI 模型）分析情绪
   ↓
3. 生成游戏专属 sessionId（格式：时间戳_用户ID）
   ↓
4. 创建游戏会话（ChatSession）
   - sessionName = "游戏会话"
   - chatId = 用户ID
   ↓
5. 保存首条游戏记录（ChatMessage）
   - messageType = MessageType.GAME
   - content = "女友生气的原因：{message},女友现在的心情：{emo}"
   - isAiResponse = false
   ↓
6. 返回情绪类型和 sessionId
```

---

### 前端处理建议

1. **调用时机**：用户点击"开始游戏"按钮，弹窗输入女友生气原因
2. **加载状态**：显示"AI 正在分析情绪..."
3. **结果处理**：
   - 保存 `sessionId` 到前端状态（用于后续对话）
   - 根据 `emo` 渲染不同颜色主题的游戏界面
4. **错误处理**：
   - `code !== 0`：显示错误提示，允许重试
   - 网络超时：提示"网络连接失败，请检查网络"

---

## 2️⃣ 游戏对话接口（流式对话）

### 接口信息

- **接口路径**：`/love/game/chat`
- **请求方式**：`POST`
- **Content-Type**：`application/json`
- **响应类型**：`text/html;charset=UTF-8`（SSE 流式传输）
- **需要登录**：✅ 是（需要 `@LoginCheck` 验证）

---

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| `message` | String | ✅ | 用户的挽回话语 | "宝贝，我错了，我以后会更关心你" |
| `chatId` | String | ✅ | 用户 ID（自动从登录态获取） | "23034480211" |
| `sessionId` | String | ✅ | 游戏会话 ID（从 `/game/emo` 接口获取） | "1729234567890_23034480211" |

**请求示例**：
```json
{
  "message": "宝贝，我错了，我以后会更关心你",
  "chatId": "23034480211",
  "sessionId": "1729234567890_23034480211"
}
```

---

### 响应结果

#### 成功响应（流式输出）

```
宝
贝
，
你
真
的
知
道
错
了
吗
？
你
每
次
都
这
么
说
...
```

**响应格式说明**：
- 采用 **SSE（Server-Sent Events）** 流式传输
- 每个汉字/标点作为一个 chunk 逐字返回
- 前端需要使用 `EventSource` 或 `fetch` 的流式 API 接收
- 流结束时连接自动关闭

---

#### 失败响应（400/500）

如果请求参数错误或 AI 调用失败，会返回 JSON 错误响应：

```json
{
  "code": 40000,
  "data": null,
  "message": "请选择会话"
}
```

---

### 流式请求示例（JavaScript）

```javascript
async function sendGameMessage(message, chatId, sessionId) {
  const response = await fetch('/love/game/chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ message, chatId, sessionId })
  });

  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let aiReply = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    const chunk = decoder.decode(value);
    aiReply += chunk;
    // 更新界面显示（逐字显示）
    updateAIReply(aiReply);
  }

  console.log('AI 完整回复:', aiReply);
}
```

## 💡 前端开发建议

### 1. 状态管理

```
gameState = {
  sessionId: null,        // 游戏会话 ID
  emotion: null,          // 女友当前情绪
  messages: [],           // 对话历史
  isLoading: false,       // 是否正在加载
  isStreaming: false      // 是否正在接收流式响应
}
```

---

### 2. UI 设计建议

**情绪主题映射**：
- **生气**：`#FF5252`（红色）+ 火焰动画
- **伤心**：`#42A5F5`（蓝色）+ 雨滴动画
- **失望**：`#90A4AE`（灰色）+ 阴云动画
- **委屈**：`#AB47BC`（紫色）+ 泪滴动画

**对话气泡样式**：
- 用户消息：靠右，浅色背景
- AI 女友消息：靠左，根据情绪显示不同颜色

---

### 3. 交互流程

```
1. 用户点击"开始游戏"
   ↓
2. 弹窗输入女友生气原因
   ↓
3. 调用 /game/emo，获取情绪和 sessionId
   ↓
4. 渲染游戏界面（根据情绪主题）
   ↓
5. 用户输入挽回话语，调用 /game/chat，需要携带chatId以及 sessionId
   ↓
6. 流式显示 AI 回复（打字机效果）
   ↓
7. 继续对话或结束游戏（删除记录）
```



- 用户主动点击"结束游戏"按钮
- 前端调用 `/deleteChatSession` 传对应的参数，删除对应的游戏会话



