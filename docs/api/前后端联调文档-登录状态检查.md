# 前后端联调文档 - 登录状态检查接口

## 快速参考

| 项目 | 内容 |
|------|------|
| 接口地址 | `/loveai/user/getLoginUser` |
| 请求方式 | GET |
| 是否需要登录 | 否（但需要检查是否有 Session） |
| 返回数据 | `{ code: 0, data: true/false, message: "ok" }` |

---

## 联调步骤

### 第一步：确认后端接口可用

**测试命令：**
```bash
curl -X GET "http://localhost:8080/loveai/user/getLoginUser" -H "Cookie: JSESSIONID=test"
```

**预期返回：**
```json
{
    "code": 0,
    "data": false,
    "message": "ok"
}
```

### 第二步：前端集成调用

**前端请求代码（推荐）：**
```javascript
// 在你的 API 封装文件中添加
export const checkLoginStatus = () => {
    return request.get('/loveai/user/getLoginUser');
};
```

**使用示例：**
```javascript
import { checkLoginStatus } from '@/api/user';

// 在应用初始化或路由守卫中调用
async function verifyLogin() {
    const res = await checkLoginStatus();
    if (res.code === 0 && !res.data) {
        // 清理本地存储并跳转登录
        localStorage.removeItem('userInfo');
        router.push('/login');
    }
}
```

### 第三步：验证联调结果

**场景 1：用户已登录**
- 前端先调用登录接口 `/loveai/user/login`
- 然后调用本接口 `/loveai/user/getLoginUser`
- 应返回 `data: true`

**场景 2：用户未登录**
- 清空浏览器 Cookie
- 直接调用本接口
- 应返回 `data: false`

**场景 3：用户已退出**
- 调用退出接口 `/loveai/user/logout`
- 再调用本接口
- 应返回 `data: false`

---

## 常见问题

### Q1: 为什么总是返回 false？
**A:** 检查前端请求是否携带了 Cookie。确保设置了 `withCredentials: true` 或 `credentials: 'include'`

### Q2: 跨域问题怎么解决？
**A:** 后端需要配置 CORS：
```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 重要：允许携带凭证
        config.addAllowedOriginPattern("*");
        config.addAllowedHeader("*");
        config.addAllowedMethod("*");
        // ... 其他配置
    }
}
```

### Q3: 什么时候应该调用这个接口？
**A:** 
- 用户刷新页面时
- 应用初始化时
- 长时间无操作后再次操作时
- 路由跳转前的权限验证

---

## 联调检查清单

- [ ] 后端接口已启动（默认 http://localhost:8080）
- [ ] 前端可以成功调用接口（无跨域错误）
- [ ] Cookie 可以正常携带
- [ ] 登录后调用接口返回 true
- [ ] 未登录时调用接口返回 false
- [ ] 退出登录后调用接口返回 false
- [ ] 前端能根据返回结果正确处理（清理本地存储、跳转登录等）

---

## 完整测试流程

```bash
# 1. 测试未登录状态
curl -X GET "http://localhost:8080/loveai/user/getLoginUser"
# 预期返回: {"code":0,"data":false,"message":"ok"}

# 2. 先登录（保存返回的 Cookie）
curl -X POST "http://localhost:8080/loveai/user/login" \
  -H "Content-Type: application/json" \
  -d '{"account":"test@example.com","password":"123456"}' \
  -c cookies.txt

# 3. 使用保存的 Cookie 测试登录状态
curl -X GET "http://localhost:8080/loveai/user/getLoginUser" \
  -b cookies.txt
# 预期返回: {"code":0,"data":true,"message":"ok"}

# 4. 退出登录
curl -X GET "http://localhost:8080/loveai/user/logout" \
  -b cookies.txt

# 5. 再次检查登录状态
curl -X GET "http://localhost:8080/loveai/user/getLoginUser" \
  -b cookies.txt
# 预期返回: {"code":0,"data":false,"message":"ok"}
```

---

## 前端完整示例代码

```javascript
// src/utils/auth.js
import axios from 'axios';

const instance = axios.create({
    baseURL: 'http://localhost:8080',
    withCredentials: true,  // 关键配置
    timeout: 5000
});

// 检查登录状态
export async function checkLogin() {
    try {
        const response = await instance.get('/loveai/user/getLoginUser');
        return response.data.data === true;
    } catch (error) {
        console.error('检查登录状态失败:', error);
        return false;
    }
}

// 在应用入口使用
export async function initApp() {
    const isLogin = await checkLogin();
    if (!isLogin) {
        // 清理过期的本地数据
        localStorage.removeItem('userInfo');
        localStorage.removeItem('token');
    }
    return isLogin;
}
```

---

**联调负责人：** 后端开发团队  
**更新日期：** 2025-10-12  
**文档版本：** v1.0


